# TreeShopTerminal.com Codebase Analysis
## Complete Structure, Architecture & Integration Guide

**Project Location:** `/Users/lockin/treeshopterminal`  
**Repository:** https://github.com/treeshoptech/treeshopterminal  
**Live URL:** https://treeshopterminal.com  
**Deployment:** Vercel (auto-deploys on main branch push)

---

## EXECUTIVE SUMMARY

TreeShopTerminal is a **Next.js 14 + Convex + Clerk** production-ready SaaS platform for tree service operations. It's a multi-tenant system with complete pricing calculation engine, cost management, work order wizards, and real-time database persistence.

**Key Stats:**
- **Language:** TypeScript
- **Frontend:** React 18 (Next.js App Router)
- **Backend:** Convex (serverless, real-time)
- **Auth:** Clerk (SSO, multi-org)
- **Database:** Convex (real-time, multi-tenant)
- **Styling:** 100% custom CSS (Neumorphism design)
- **Code Size:** ~2,000 lines Convex backend + 80+ frontend files
- **Status:** Production-ready, shipping with real customers

---

## PROJECT DIRECTORY STRUCTURE

```
/Users/lockin/treeshopterminal/
├── app/                              # Next.js App Router pages
│   ├── page.tsx                      # Main dashboard (entry point)
│   ├── layout.tsx                    # Root layout with providers
│   ├── employees/page.tsx            # Team management
│   ├── equipment/page.tsx            # Equipment library
│   ├── loadouts/page.tsx             # Service configurations
│   ├── pricing/page.tsx              # Pricing tools
│   ├── projects/page.tsx             # Project management
│   ├── settings/page.tsx             # Organization settings
│   └── sign-in/[[...sign-in]]/       # Clerk auth pages
│
├── components/                        # Reusable React components
│   ├── layout/
│   │   ├── AppShell.tsx              # Main app container
│   │   ├── DesktopHeader.tsx         # Top navigation bar
│   │   ├── MobileNav.tsx             # Mobile navigation
│   │   ├── NavButton.tsx             # Navigation item
│   │   ├── SlideNav.tsx              # Slide-out menu
│   │   ├── ThemeProvider.tsx         # Dark mode provider
│   │   └── ThemeToggle.tsx           # Theme switcher
│   │
│   ├── providers/
│   │   └── ConvexClientProvider.tsx  # Convex + Clerk setup
│   │
│   ├── ui/                           # Reusable UI components
│   │   ├── Button.tsx                # Button (5 variants)
│   │   ├── Card.tsx                  # Card container
│   │   ├── Input.tsx                 # Form input
│   │   ├── Modal.tsx                 # Dialog/modal
│   │   ├── Select.tsx                # Dropdown
│   │   ├── Badge.tsx                 # Status badge
│   │   └── ActionMenu.tsx            # Dropdown menu
│   │
│   ├── team/
│   │   ├── EmployeeCard.tsx          # Employee display
│   │   └── CreateEmployeeModal.tsx   # Add employee form
│   │
│   ├── customers/
│   │   └── CustomerCard.tsx          # Customer display
│   │
│   └── time/
│       └── TimeEntryCard.tsx         # Time tracking display
│
├── convex/                            # Backend serverless functions
│   ├── _generated/                   # Auto-generated by Convex
│   │   ├── api.d.ts
│   │   ├── api.js
│   │   ├── server.d.ts
│   │   └── server.js
│   │
│   ├── schema.ts                     # Database schema (CRITICAL)
│   ├── auth.ts                       # Authentication functions
│   ├── auth.config.ts                # Auth configuration
│   │
│   ├── queries/ (via individual files)
│   ├── mutations/ (via individual files)
│   │   ├── companies.ts              # Company CRUD
│   │   ├── equipment.ts              # Equipment library
│   │   ├── employees.ts              # Team management
│   │   ├── loadouts.ts               # Service loadouts
│   │   ├── customers.ts              # Customer directory
│   │   ├── jobSites.ts               # Job site locations
│   │   ├── workAreas.ts              # Work area polygons
│   │   ├── projects.ts               # Project tracking
│   │   ├── workOrders.ts             # Work orders
│   │   ├── quotes.ts                 # Quote generation
│   │   ├── timeTracker.ts            # Time entries
│   │   ├── whitelist.ts              # Access control
│   │   └── seedData.ts               # Demo data
│
├── lib/                               # Business logic utilities
│   ├── formulas/
│   │   └── pricing.ts                # ALL pricing formulas (CRITICAL)
│   ├── hooks/
│   │   └── useOrganization.ts        # Org management hook
│   └── maps/
│       └── google-maps.ts            # Google Maps utilities
│
├── styles/                            # Design system CSS
│   ├── variables.css                 # Design tokens
│   ├── globals.css                   # Global styles
│   └── design-system.css             # Component styles
│
├── public/                            # Static assets
│   ├── manifest.json                 # PWA manifest
│   └── sw.js                         # Service worker
│
├── middleware.ts                      # Clerk auth middleware
├── next.config.js                    # Next.js configuration
├── tsconfig.json                     # TypeScript config
├── package.json                      # Dependencies
├── .env.local                        # Environment variables
├── vercel.json                       # Vercel config
│
├── README.md                         # Feature documentation
├── DEPLOYMENT.md                     # Deployment guide
├── CLERK-CONVEX-SETUP.md            # Auth setup guide
└── FEATURES-COMPLETED.md            # Completed features list
```

---

## CORE SYSTEMS & CRITICAL FILES

### 1. ENTRY POINT: app/page.tsx

**What it does:** Main dashboard showing business KPIs and onboarding steps

**Responsibilities:**
- Displays equipment fleet value
- Shows employee count and labor costs
- Lists saved loadouts
- Shows onboarding progress
- Links to setup workflows

**Key Dependencies:**
- `useOrganization()` hook for org ID
- Convex queries for equipment, employees, loadouts
- `@clerk/nextjs` for auth check

**Lines of Code:** ~50-100 (dashboard display)

---

### 2. CONVEX SCHEMA: convex/schema.ts

**What it does:** Defines complete database schema with multi-tenant architecture

**Critical Tables (14 tables total):**

#### Core Multi-Tenant:
- `companies` - Organization records (clerkOrgId, name, business settings)
- `userProfiles` - User preferences and auth

#### Business Operations:
- `equipment` - Asset library with hourly costs
- `employees` - Crew with burden multipliers
- `loadouts` - Equipment + labor configurations
- `customers` - Client directory
- `jobSites` - Physical locations (with coordinates)
- `workAreas` - Named polygons on job sites
- `projects` - Project lifecycle management
- `workOrders` - Job assignments
- `quotes` - Generated pricing quotes
- `timeEntries` - Time tracking
- `invoices` - Billing records

#### Security:
- `whitelist` - Access control

**Critical Features:**
- Multi-tenant isolation via `organizationId` field on every table
- Indexes for fast lookups (by clerkOrgId, by slug, etc.)
- Flexible schema (most fields optional for migration)
- Timestamps on all records (createdAt, updatedAt)
- Structured objects (coordinates, defaultSettings, businessHours)

**Lines of Code:** ~1,000+ (comprehensive schema)

**MUST PRESERVE:**
- All table definitions
- Index structure
- Relationship patterns (organizationId references)
- Default settings structure

---

### 3. PRICING ENGINE: lib/formulas/pricing.ts

**What it does:** Complete formula implementation for all TreeShop pricing calculations

**Implemented Formulas (6 complete steps):**

1. **Equipment Hourly Cost**
   ```
   Ownership/Hour = (Depreciation + Finance + Insurance + Reg) / Annual Hours
   Operating/Hour = (Fuel + Maintenance + Repairs) / Annual Hours
   Total/Hour = Ownership + Operating
   ```

2. **Employee True Labor Cost**
   ```
   True Cost/Hour = Base Rate × Burden Multiplier
   ```

3. **Loadout Cost**
   ```
   Loadout/Hour = Σ Equipment/Hour + Σ Labor/Hour + Overhead
   ```

4. **Profit Margin to Billing Rate**
   ```
   Billing Rate = Cost ÷ (1 - Desired Margin%)
   Example: Cost ÷ 0.50 for 50% margin
   ```

5. **Inch-Acres (Forestry Mulching)**
   ```
   Score = DBH (inches) × Acreage
   Time = Score ÷ Production Rate (IA/hour)
   ```

6. **StumpScore (Stump Grinding)**
   ```
   Score = D² × (Height + Depth) × Modifiers
   Time = Score ÷ 400 (points/hour default)
   ```

**Production Rates (baked in constants):**
- Cat 265 Forestry Mulcher: 1.3 IA/hour
- SK200TR Mulcher: 5.0 IA/hour
- Stump Grinder: 400 points/hour
- Land Clearing: 8 hours/day

**Burden Multipliers:**
- Entry Ground Crew: 1.6x
- Experienced Climber: 1.7x
- Crew Leader: 1.8x
- Certified Arborist: 1.9x
- Specialized Operator: 2.0x

**Default Settings:**
- Profit Margin: 50%
- Transport Rate: 50% of loadout cost
- Buffer: 10% of work time

**Lines of Code:** 500+ (all formulas complete)

**MUST PRESERVE:**
- All formula logic (do not modify calculations)
- Production rate constants
- Burden multiplier values
- Margin calculation pattern
- Export function signatures

---

### 4. AUTHENTICATION: middleware.ts & convex/auth.ts

**What it does:** Secures routes and enforces multi-tenant data isolation

**Flow:**
1. User visits any route
2. Clerk middleware intercepts request
3. If not on public route (`/`, `/sign-in`), requires auth
4. After auth, Clerk provides JWT with org ID
5. Convex functions receive JWT and extract org ID
6. All queries filtered by organization

**Configuration:**
- Public routes: `/`, `/sign-in/**`, `/api/webhooks/**`
- Protected routes: Everything else
- Auth provider: Clerk (SSO)
- Database integration: Convex + Clerk

**MUST PRESERVE:**
- Middleware.ts route matcher
- ConvexProviderWithClerk setup
- Auth context in Convex functions
- Organization ID extraction from JWT

---

### 5. DEPLOYMENT: DEPLOYMENT.md + vercel.json

**Hosting:** Vercel (auto-deploy on main push)
**Domain:** treeshopterminal.com

**Production Environment Variables:**
```
NEXT_PUBLIC_CONVEX_URL=https://effervescent-horse-265.convex.cloud
CONVEX_DEPLOYMENT=prod:effervescent-horse-265
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_Y2xvc2UtdG9tY2F0LTY0...
CLERK_SECRET_KEY=sk_test_eHWVHT9n4nn106Y0GQNG4e3b64urKHSTpdFFHEKLxS
NEXT_PUBLIC_BASE_URL=https://treeshopterminal.com
```

**Build Process:**
1. `npm run build` (triggers Next.js build)
2. `npm run build:convex` (deploys backend to Convex)
3. Vercel serves Next.js frontend
4. Convex handles all backend queries/mutations

**MUST PRESERVE:**
- Environment variable names (case-sensitive)
- Convex deployment URL
- Clerk auth keys
- Vercel configuration

---

## CONVEX BACKEND ARCHITECTURE

### File Organization (1,980 lines total)

```
convex/
├── schema.ts              (~500 lines)  - Database schema
├── auth.ts                (~200 lines)  - Authentication
├── companies.ts           (~150 lines)  - Company CRUD
├── equipment.ts           (~150 lines)  - Equipment CRUD
├── employees.ts           (~150 lines)  - Employee CRUD
├── loadouts.ts            (~150 lines)  - Loadout CRUD
├── customers.ts           (~150 lines)  - Customer CRUD
├── jobSites.ts            (~150 lines)  - Job site CRUD
├── workAreas.ts           (~150 lines)  - Work area CRUD
├── projects.ts            (~150 lines)  - Project CRUD
├── workOrders.ts          (~150 lines)  - Work order CRUD
├── quotes.ts              (~150 lines)  - Quote CRUD
├── timeTracker.ts         (~100 lines)  - Time entry CRUD
├── whitelist.ts           (~100 lines)  - Access control
└── seedData.ts            (~100 lines)  - Demo data
```

### Pattern: Every Backend File Has

1. **Imports**
   ```typescript
   import { mutation, query } from "./_generated/server";
   import { v } from "convex/values";
   ```

2. **Authentication Helper**
   ```typescript
   async function getCurrentOrganizationId(ctx: QueryCtx): Promise<string> {
     const identity = await ctx.auth.getUserIdentity();
     // Extract organization ID from identity or Clerk JWT
   }
   ```

3. **Queries** (read-only, real-time)
   ```typescript
   export const list = query({
     args: {},
     handler: async (ctx) => {
       const orgId = await getCurrentOrganizationId(ctx);
       return ctx.db.query("table").filter(q => q.eq(q.field("organizationId"), orgId)).collect();
     }
   });
   ```

4. **Mutations** (write operations)
   ```typescript
   export const create = mutation({
     args: { name: v.string(), ... },
     handler: async (ctx, args) => {
       const orgId = await getCurrentOrganizationId(ctx);
       return ctx.db.insert("table", { organizationId: orgId, ...args });
     }
   });
   ```

### Real-Time Features

- Convex provides **live queries** - UI updates instantly when data changes
- Used in `useQuery()` hooks - component re-renders on data change
- No manual cache invalidation needed

---

## DATA FLOW EXAMPLES

### Example 1: Add Equipment to Library

```
User enters equipment details in form
         ↓
Clicks "Save to Equipment Library"
         ↓
Frontend calls: api.equipment.create({name, cost, etc})
         ↓
Convex mutation receives request
         ↓
Extracts organizationId from JWT (Clerk)
         ↓
Validates user has permission
         ↓
Inserts equipment record with organizationId
         ↓
Returns new equipment ID
         ↓
Frontend query updates in real-time
         ↓
UI displays new equipment card
```

### Example 2: Generate Work Order Quote

```
User draws work area on map
         ↓
System calculates acres (Google Maps Geometry)
         ↓
User names and saves work area
         ↓
Convex: workAreas.create()
         ↓
User opens Work Order Wizard
         ↓
Convex: workAreas.list({jobSiteId})
         ↓
User selects service type (Forestry Mulching)
         ↓
User enters acreage (already from work area)
         ↓
User selects DBH package (6")
         ↓
Frontend calculates: 6" × acres = inch-acres (using lib/formulas/pricing.ts)
         ↓
Frontend calculates: hours = inch-acres ÷ 1.3 IA/hr
         ↓
Frontend calculates: price = hours × billing rate
         ↓
Displays price range (low 30% margin / high 50% margin)
         ↓
User confirms
         ↓
Convex: quotes.create({...calculation results})
         ↓
Convex: workOrders.create({quoteId, ...})
         ↓
Work order created with linked quote
```

---

## WHAT EACH PAGE DOES

### 1. HomePage (`/app/page.tsx`)
- Main dashboard
- Shows equipment fleet value
- Shows employee count + labor costs
- Lists loadouts
- Shows onboarding checklist
- Entry point for all workflows

### 2. Equipment Page (`/app/equipment/page.tsx`)
- Lists all equipment
- Filter by category
- Edit equipment
- Delete equipment
- Search functionality
- Add via calculator

### 3. Employees Page (`/app/employees/page.tsx`)
- Lists all team members
- Shows positions
- Shows true labor cost
- Create/edit/delete
- View performance metrics

### 4. Loadouts Page (`/app/loadouts/page.tsx`)
- Lists equipment + labor configurations
- Shows production rate
- Shows hourly cost
- Shows billing rates at different margins
- Create/edit/delete
- Used for quote generation

### 5. Pricing Page (`/app/pricing/page.tsx`)
- Link to pricing calculators
- Equipment cost calculator
- Employee cost calculator
- Project pricing calculator
- ROI comparison tool

### 6. Projects Page (`/app/projects/page.tsx`)
- Lists all projects
- Filter by status (Lead, Proposal, Work Order, Invoice)
- Create new project
- View project details
- Link to customers and job sites

### 7. Settings Page (`/app/settings/page.tsx`)
- Organization profile
- Business settings
- Default profit margin
- Default transport rate
- Business hours
- Service area radius

### 8. Sign In (`/app/sign-in/[[...sign-in]]/page.tsx`)
- Clerk sign-in page
- Dark themed
- Redirects after auth

---

## PACKAGE DEPENDENCIES

### Core Framework
```json
{
  "next": "^14.2.33",
  "react": "^18.3.1",
  "react-dom": "^18.3.1",
  "typescript": "^5"
}
```

### Backend & Database
```json
{
  "convex": "^1.25.4",
  "@convex-dev/auth": "^0.0.90"
}
```

### Authentication
```json
{
  "@clerk/nextjs": "^6.33.3"
}
```

### Forms & Validation
```json
{
  "react-hook-form": "^7.62.0",
  "zod": "^3.23.8",
  "@hookform/resolvers": "^5.2.2"
}
```

### Maps & Location
```json
{
  "@react-google-maps/api": "^2.19.3",
  "@google/maps": "^1.1.3"
}
```

### UI & Design
```json
{
  "lucide-react": "^0.544.0",
  "framer-motion": "^11.0.0",
  "clsx": "^2.1.1"
}
```

### Other
```json
{
  "date-fns": "^4.1.0",
  "stripe": "^18.4.0",
  "@stripe/stripe-js": "^7.8.0",
  "puppeteer": "^24.24.0",
  "bcryptjs": "^3.0.2"
}
```

---

## ENVIRONMENT VARIABLES

### Required Variables (in .env.local for dev, Vercel for prod)

```bash
# Convex Backend
NEXT_PUBLIC_CONVEX_URL=https://effervescent-horse-265.convex.cloud
CONVEX_DEPLOYMENT=dev:enduring-weasel-794  # dev
CONVEX_DEPLOYMENT=prod:effervescent-horse-265  # prod

# Clerk Authentication
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_Y2xvc2UtdG9tY2F0LTY0LmNsZXJrLmFjY291bnRzLmRldiQ
CLERK_SECRET_KEY=sk_test_eHWVHT9n4nn106Y0GQNG4e3b64urKHSTpdFFHEKLxS

# Google Maps (optional)
NEXT_PUBLIC_GOOGLE_MAPS_API_KEY=
GOOGLE_MAPS_API_KEY=

# Stripe (optional)
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=
STRIPE_SECRET_KEY=

# Application
NEXT_PUBLIC_BASE_URL=http://localhost:3002  # dev
NEXT_PUBLIC_BASE_URL=https://treeshopterminal.com  # prod
NODE_ENV=development  # dev
NODE_ENV=production  # prod
```

---

## HOW TO RUN LOCALLY

```bash
cd /Users/lockin/treeshopterminal

# Terminal 1: Start Next.js dev server
npm run dev
# → http://localhost:3002

# Terminal 2: Start Convex backend
npx convex dev
# → Syncs schema, runs functions in dev mode
```

**First time?**
1. Install dependencies: `npm install`
2. Copy `.env.example` to `.env.local`
3. Fill in Convex URL and Clerk keys
4. Run both commands above

---

## CRITICAL FILES TO PRESERVE

When replacing/upgrading components, MUST keep:

1. **convex/schema.ts** - Database schema
   - Do not remove tables or fields
   - Add new fields as optional
   - Maintain index structure

2. **lib/formulas/pricing.ts** - All pricing calculations
   - Do not modify formula logic
   - Keep production rate constants
   - Keep burden multipliers

3. **middleware.ts** - Route authentication
   - Required for Clerk integration
   - Controls which routes need auth

4. **convex/auth.ts** - Authentication functions
   - Required for getCurrentOrganizationId()
   - Enforces multi-tenant isolation

5. **.env.local** - Environment configuration
   - Convex URL
   - Clerk keys
   - API keys

6. **app/layout.tsx** - Root layout with providers
   - Clerk and Convex wrappers
   - Design system styles

---

## WHAT CAN BE REPLACED

Components that can be replaced without breaking core functionality:

1. **Individual page components** (`app/*/page.tsx`)
   - Can redesign UI
   - Keep Convex query pattern
   - Maintain form structure

2. **React components** (`components/ui/*.tsx`, `components/team/*.tsx`, etc.)
   - Can be redesigned
   - Must maintain prop interfaces
   - Keep the same Convex hooks

3. **CSS/Styling** (`styles/*.css`)
   - Can completely redesign
   - Neumorphism can be replaced
   - Keep CSS module pattern

4. **Page layout** (`components/layout/*.tsx`)
   - Can redesign navigation
   - Can change header/footer
   - Keep AppShell wrapper

5. **Individual Convex handlers** (`convex/*.ts`)
   - Can add new queries/mutations
   - Can modify field values
   - Keep schema structure intact

---

## DEPLOYMENT CHECKLIST

Before pushing to production:

- [ ] Environment variables set in Vercel
- [ ] Convex deployment URL configured
- [ ] Clerk auth keys in Vercel
- [ ] `npm run build` succeeds locally
- [ ] No TypeScript errors
- [ ] Dashboard loads after deploy
- [ ] Can create equipment/employees
- [ ] Can generate quotes
- [ ] Auth flow works
- [ ] No console errors in production

---

## COMMON TASKS & FILE LOCATIONS

### Add a new pricing calculator
**Files to modify:**
- `app/pricing/page.tsx` - Add calculator UI
- `lib/formulas/pricing.ts` - Add formula function
- `convex/quotes.ts` - Store calculation results

### Add a new database table
**Files to modify:**
- `convex/schema.ts` - Define table
- `convex/[tableName].ts` - Create CRUD functions
- Run `npx convex dev` to deploy schema

### Change authentication
**Files to modify:**
- `middleware.ts` - Auth logic
- `convex/auth.ts` - Backend auth
- `app/layout.tsx` - Auth provider

### Modify pricing formulas
**Files to modify:**
- `lib/formulas/pricing.ts` - Update calculations
- `convex/quotes.ts` - Update quote generation
- Frontend components that use formulas

### Change UI design
**Files to modify:**
- `styles/variables.css` - Design tokens
- `styles/globals.css` - Global styles
- `components/ui/*.module.css` - Component styles
- `components/**/*.tsx` - Component structure

---

## QUICK STATS

- **Next.js Version:** 14.2.33
- **React Version:** 18.3.1
- **Convex Version:** 1.25.4
- **Clerk Version:** 6.33.3
- **Frontend Files:** 80+ components
- **Backend Files:** 14 modules (1,980 lines)
- **Database Tables:** 14 tables
- **Routes:** 7 main pages + sign-in
- **Total Components:** 30+ reusable UI components
- **Code Status:** Production-ready
- **Last Update:** Oct 13, 2024

---

## INTEGRATION POINTS WITH TREE SHOP OPERATIONS

This system is designed to work with:

1. **TreeShop.app** - The main SaaS application (iOS)
   - Uses same database schema
   - Same pricing formulas
   - Same Convex backend

2. **TreeShop Pricing System** (CLAUDE.md)
   - All 6 formula steps implemented
   - All production rates defined
   - All burden multipliers configured

3. **Clerk Auth**
   - Multi-org support
   - User management
   - JWT-based security

4. **Google Maps**
   - Drive time calculations
   - Work area mapping
   - Geofencing (future)

---

## NEXT STEPS FOR NEW FEATURES

To add a new feature to TreeShopTerminal:

1. **Define database schema** - Add table to `convex/schema.ts`
2. **Create backend module** - New file in `convex/[feature].ts` with CRUD
3. **Build frontend page** - New page in `app/[feature]/page.tsx`
4. **Add UI components** - Reusable components in `components/[feature]/`
5. **Deploy** - Push to main, Vercel auto-deploys
6. **Test** - Verify auth isolation, data persistence, formula accuracy

---

**Document Created:** 2025-11-05  
**Project Status:** Production  
**Maintenance:** Active development  
**Last Tested:** Oct 13, 2024
